{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "JidoWorkflow Workflow Definition",
  "type": "object",
  "additionalProperties": false,
  "required": ["name", "version"],
  "properties": {
    "name": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9_]*$"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$"
    },
    "description": {
      "type": "string"
    },
    "enabled": {
      "type": "boolean",
      "default": true
    },
    "inputs": {
      "type": "array",
      "items": { "$ref": "#/definitions/input_declaration" }
    },
    "triggers": {
      "type": "array",
      "items": { "$ref": "#/definitions/trigger" }
    },
    "settings": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "max_concurrency": { "type": "integer", "minimum": 1 },
        "timeout_ms": { "type": "integer", "minimum": 1000 },
        "retry_policy": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "max_retries": { "type": "integer", "minimum": 0 },
            "backoff": { "enum": ["linear", "exponential", "constant"] },
            "base_delay_ms": { "type": "integer", "minimum": 0 }
          }
        },
        "on_failure": { "enum": ["compensate", "halt", "continue"] }
      }
    },
    "signals": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "topic": { "type": "string", "minLength": 1, "pattern": ".*\\S.*" },
        "publish_events": {
          "type": "array",
          "items": { "enum": ["step_started", "step_completed", "step_failed", "workflow_complete", "agent_state"] }
        }
      }
    },
    "steps": {
      "type": "array",
      "items": { "$ref": "#/definitions/step" }
    },
    "error_handling": {
      "type": "array",
      "items": { "$ref": "#/definitions/error_handler" }
    },
    "return": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "value": { "type": "string", "minLength": 1, "pattern": ".*\\S.*" },
        "transform": { "type": "string" }
      }
    }
  },
  "definitions": {
    "input_declaration": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "type"],
      "properties": {
        "name": { "type": "string", "minLength": 1, "pattern": ".*\\S.*" },
        "type": { "enum": ["string", "integer", "boolean", "map", "list"] },
        "required": { "type": "boolean", "default": false },
        "default": {},
        "description": { "type": "string" }
      },
      "allOf": [
        {
          "if": {
            "properties": { "type": { "const": "string" } }
          },
          "then": {
            "properties": { "default": { "type": "string" } }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "integer" } }
          },
          "then": {
            "properties": { "default": { "type": "integer" } }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "boolean" } }
          },
          "then": {
            "properties": { "default": { "type": "boolean" } }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "map" } }
          },
          "then": {
            "properties": { "default": { "type": "object" } }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "list" } }
          },
          "then": {
            "properties": { "default": { "type": "array" } }
          }
        }
      ]
    },
    "trigger": {
      "type": "object",
      "required": ["type"],
      "oneOf": [
        { "$ref": "#/definitions/file_system_trigger" },
        { "$ref": "#/definitions/git_hook_trigger" },
        { "$ref": "#/definitions/signal_trigger" },
        { "$ref": "#/definitions/scheduled_trigger" },
        { "$ref": "#/definitions/manual_trigger" }
      ]
    },
    "file_system_trigger": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "type": { "const": "file_system" },
        "patterns": {
          "type": "array",
          "items": { "type": "string", "minLength": 1, "pattern": ".*\\S.*" },
          "minItems": 1
        },
        "events": {
          "type": "array",
          "items": {
            "enum": ["created", "modified", "deleted", "moved", "renamed", "closed", "updated"]
          }
        },
        "debounce_ms": { "type": "integer", "minimum": 0 }
      },
      "required": ["type", "patterns"]
    },
    "git_hook_trigger": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "type": { "const": "git_hook" },
        "events": { "type": "array", "items": { "enum": ["commit", "push", "merge"] } }
      },
      "required": ["type"]
    },
    "signal_trigger": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "type": { "const": "signal" },
        "patterns": {
          "type": "array",
          "items": { "type": "string", "minLength": 1, "pattern": ".*\\S.*" },
          "minItems": 1
        }
      },
      "required": ["type", "patterns"]
    },
    "scheduled_trigger": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "type": { "const": "scheduled" },
        "schedule": { "type": "string", "minLength": 1, "pattern": ".*\\S.*" }
      },
      "required": ["type", "schedule"]
    },
    "manual_trigger": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "type": { "const": "manual" },
        "command": { "type": "string", "minLength": 1, "pattern": ".*\\S.*" }
      },
      "required": ["type"]
    },
    "error_handler": {
      "type": "object",
      "additionalProperties": false,
      "required": ["handler"],
      "properties": {
        "handler": { "type": "string", "minLength": 1, "pattern": ".*\\S.*" },
        "action": { "type": "string", "minLength": 1 },
        "inputs": { "type": ["object", "array"] }
      },
      "allOf": [
        {
          "if": {
            "required": ["handler"],
            "properties": {
              "handler": { "type": "string", "pattern": "^compensate:" }
            }
          },
          "then": {
            "required": ["action"],
            "properties": {
              "action": { "type": "string", "minLength": 1, "pattern": ".*\\S.*" }
            }
          }
        }
      ]
    },
    "step": {
      "type": "object",
      "required": ["name", "type"],
      "oneOf": [
        { "$ref": "#/definitions/action_step" },
        { "$ref": "#/definitions/agent_step" },
        { "$ref": "#/definitions/skill_step" },
        { "$ref": "#/definitions/sub_workflow_step" }
      ]
    },
    "action_step": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "name": { "type": "string", "minLength": 1, "pattern": ".*\\S.*" },
        "type": { "const": "action" },
        "module": { "type": "string", "minLength": 1, "pattern": ".*\\S.*" },
        "inputs": { "type": ["object", "array"] },
        "outputs": { "type": "array", "items": { "type": "string" } },
        "depends_on": { "type": "array", "items": { "type": "string" } },
        "async": { "type": "boolean" },
        "optional": { "type": "boolean" },
        "timeout_ms": { "type": "integer", "minimum": 1 },
        "max_retries": { "type": "integer", "minimum": 0 }
      },
      "required": ["name", "type", "module"]
    },
    "agent_step": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "name": { "type": "string", "minLength": 1, "pattern": ".*\\S.*" },
        "type": { "const": "agent" },
        "agent": { "type": "string", "minLength": 1, "pattern": ".*\\S.*" },
        "callback_signal": { "type": "string", "minLength": 1, "pattern": ".*\\S.*" },
        "inputs": { "type": ["object", "array"] },
        "depends_on": { "type": "array", "items": { "type": "string" } },
        "mode": { "enum": ["sync", "async"] },
        "timeout_ms": { "type": "integer", "minimum": 1 },
        "pre_actions": { "type": "array", "items": { "type": "object" } },
        "post_actions": { "type": "array", "items": { "type": "object" } }
      },
      "required": ["name", "type", "agent"]
    },
    "skill_step": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "name": { "type": "string", "minLength": 1, "pattern": ".*\\S.*" },
        "type": { "const": "skill" },
        "module": { "type": "string", "minLength": 1, "pattern": ".*\\S.*" },
        "inputs": { "type": ["object", "array"] },
        "outputs": { "type": "array", "items": { "type": "string" } },
        "depends_on": { "type": "array", "items": { "type": "string" } },
        "async": { "type": "boolean" },
        "optional": { "type": "boolean" },
        "timeout_ms": { "type": "integer", "minimum": 1 },
        "max_retries": { "type": "integer", "minimum": 0 }
      },
      "required": ["name", "type", "module"]
    },
    "sub_workflow_step": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "name": { "type": "string", "minLength": 1, "pattern": ".*\\S.*" },
        "type": { "const": "sub_workflow" },
        "workflow": { "type": "string", "minLength": 1, "pattern": ".*\\S.*" },
        "inputs": { "type": ["object", "array"] },
        "depends_on": { "type": "array", "items": { "type": "string" } },
        "condition": { "type": "string" },
        "parallel": { "type": "boolean" },
        "timeout_ms": { "type": "integer", "minimum": 1 }
      },
      "required": ["name", "type", "workflow"]
    }
  }
}
